# HAProxy Configuration for Zipline Production 2-Node Setup
# REAL PRODUCTION - Uses actual node IPs

global
    log stdout local0
    stats socket /var/lib/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    daemon
    maxconn 4096

defaults
    mode tcp
    log global
    retries 3
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    option redispatch

# Statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats admin if TRUE
    stats auth admin:admin123

# PostgreSQL Primary (Read/Write) - Port 5000
listen postgres_primary
    bind *:5000
    mode tcp
    timeout client 0
    timeout server 0
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    
    server zipline-node1 10.10.10.150:5432 check port 8008
    server zipline-node2 10.10.10.105:5432 check port 8008

# PostgreSQL Replicas (Read-Only) - Port 5001
listen postgres_replicas
    bind *:5001
    mode tcp
    balance roundrobin
    timeout client 0
    timeout server 0
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    
    server zipline-node1-ro 10.10.10.150:5432 check port 8008
    server zipline-node2-ro 10.10.10.105:5432 check port 8008

# Patroni REST API Proxy - Port 8008
listen patroni_api
    bind *:8008
    mode http
    balance roundrobin
    option httpchk GET /cluster
    http-check expect status 200
    
    server zipline-node1-api 10.10.10.150:8008 check
    server zipline-node2-api 10.10.10.105:8008 check
